(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))s(r);new MutationObserver(r=>{for(const i of r)if(i.type==="childList")for(const c of i.addedNodes)c.tagName==="LINK"&&c.rel==="modulepreload"&&s(c)}).observe(document,{childList:!0,subtree:!0});function o(r){const i={};return r.integrity&&(i.integrity=r.integrity),r.referrerPolicy&&(i.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?i.credentials="include":r.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function s(r){if(r.ep)return;r.ep=!0;const i=o(r);fetch(r.href,i)}})();let fe="",ge="";function Je(e){fe=e}function ze(e){ge=e}function Qe(){return"https://api.telegram.org"}function ye(e){const t=`${Qe()}/bot${fe}/${e}`,o=ge.trim();return o?o.replace(/\/+$/,"")+"/"+t:t}function Ze(e){const t=`${Qe()}/file/bot${fe}/${e}`,o=ge.trim();return o?o.replace(/\/+$/,"")+"/"+t:t}async function et(e,t){const o=t?"?"+new URLSearchParams(t).toString():"";return(await fetch(ye(e)+o)).json()}async function k(e,t){return(await fetch(ye(e),{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t||{})})).json()}async function tt(e,t){return(await fetch(ye(e),{method:"POST",body:t})).json()}async function nt(){return et("getMe")}async function xt(e,t=0,o=["message","edited_message","channel_post","edited_channel_post"]){return k("getUpdates",{offset:e,timeout:t,allowed_updates:o})}async function Dt(e,t="typing"){return k("sendChatAction",{chat_id:e,action:t})}async function Nt(e,t){return k("sendSticker",{chat_id:e,sticker:t})}async function Ut(e,t){return k("deleteMessage",{chat_id:e,message_id:parseInt(t,10)})}async function ot(e){return et("getFile",{file_id:e})}async function At(e){return k("getChat",{chat_id:e})}async function Pt(e){return k("getChatAdministrators",{chat_id:e})}async function Ot(e,t,o){return k("banChatMember",{chat_id:e,user_id:t})}async function re(e,t,o={}){return k("promoteChatMember",{chat_id:e,user_id:t,can_manage_chat:o.can_manage_chat!==!1,can_delete_messages:o.can_delete_messages!==!1,can_manage_video_chats:o.can_manage_video_chats!==!1,can_restrict_members:o.can_restrict_members!==!1,can_promote_members:o.can_promote_members||!1,can_change_info:o.can_change_info!==!1,can_invite_users:o.can_invite_users!==!1,can_pin_messages:o.can_pin_messages!==!1,is_anonymous:o.is_anonymous||!1})}async function Ft(e,t,o={},s){return k("restrictChatMember",{chat_id:e,user_id:t,permissions:o})}async function Rt(e,t){return k("getChatMember",{chat_id:e,user_id:t})}async function Ht(e,t){return k("setChatTitle",{chat_id:e,title:t})}async function $t(e,t){return k("setChatDescription",{chat_id:e,description:t})}async function Kt(e,t){const o=new FormData;return o.append("chat_id",e),o.append("photo",t),tt("setChatPhoto",o)}async function Yt(e=!1){return k("deleteWebhook",{drop_pending_updates:e})}async function jt(e,t){return k("getMyCommands",{})}async function Gt(e){return k("getMyDescription",{})}async function Wt(e){return k("getMyShortDescription",{})}function Xt(e){return new Date(e).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})}function F(e){var i,c;const t=(e||"").trim();if(!t)return"?";const o=t.split(/\s+/).filter(Boolean),s=((i=o[0])==null?void 0:i[0])||"",r=((c=o[1])==null?void 0:c[0])||"";return(s+r).toUpperCase()||s.toUpperCase()||"?"}function ne(e){return(e||"").replace(/\s+/g," ").slice(0,60)}function qt(e){return e.from?[e.from.first_name,e.from.last_name].filter(Boolean).join(" ")||e.from.username||"Ng∆∞·ªùi d√πng":e.author_signature?e.author_signature:"H·ªá th·ªëng"}function Vt(e){return e.from&&e.from.username?e.from.username:null}function Jt(){try{const e=new(window.AudioContext||window.webkitAudioContext),t=e.createOscillator(),o=e.createGain();t.type="sine",t.frequency.value=680,o.gain.value=.04,t.connect(o),o.connect(e.destination),t.start(),setTimeout(()=>{t.stop(),e.close()},180)}catch{}}function R(e){e&&(e.scrollTop=e.scrollHeight)}function Ee(e){return e?e.scrollTop+e.clientHeight>=e.scrollHeight-20:!0}let E="",v=new Map,m=null,be=0,M=st(),A=null;function Q(){return{canDeleteMessages:!1,canPromoteMembers:!1,canRestrictMembers:!1,canChangeInfo:!1,canInviteUsers:!1}}function st(){return{id:null,username:null,name:null,description:null,shortDescription:null,commands:[]}}function ve(e){if(!e)return e;if(e.messageIds instanceof Set||(e.messageIds=new Set(e.messageIds||[])),!(e.members instanceof Map)){let t=[];Array.isArray(e.members)?t=e.members:e.members&&typeof e.members=="object"&&(t=Object.entries(e.members)),e.members=new Map(t.map(([o,s])=>[String(o),s]))}return e.permissions={...Q(),...e.permissions||{}},e.avatarText||(e.avatarText="?"),e}function zt(e){if(!e||!e.id)return null;const t=String(e.id),o=e.first_name||e.firstName||"",s=e.last_name||e.lastName||"",r=e.displayName||[o,s].filter(Boolean).join(" ")||e.username||e.name||"Ng∆∞·ªùi d√πng",i=e.avatarText||F(r),c=e.status||(e.isCreator?"creator":e.isAdmin?"administrator":"member");return{id:t,firstName:o||null,lastName:s||null,username:e.username||null,displayName:r,avatarText:i,status:c,isAdmin:e.isAdmin??(c==="administrator"||c==="creator"),isCreator:e.isCreator??c==="creator",isBot:e.isBot??e.is_bot??!1,joinedDate:e.joinedDate||e.joined_date||null,lastSeen:e.lastSeen||Date.now(),raw:e.raw||null}}function $e(e){return e.isCreator?0:e.status==="administrator"||e.isAdmin?1:e.status==="moderator"?2:3}function rt(e){E=e}function Qt(e){const t=new Map;e&&typeof e.forEach=="function"&&e.forEach((o,s)=>{const r=ve({...o,id:String(o.id||s)});t.set(String(s),r)}),v=t}function Zt(e,t){const o=ve({...t,id:String(e)});v.set(String(e),o)}function b(e){return v.get(String(e))}function en(e){v.delete(String(e))}function ke(e){m=String(e)||null}function it(e){be=e}function at(e){M={...M,...e}}function tn(e){A=e}function nn(){A=null}function on(){v=new Map,m=null,A=null,be=0,M=st()}function sn(e){const t=b(e);return(t==null?void 0:t.members)||new Map}function ct(e){const t=sn(e);return Array.from(t.values()).sort((o,s)=>{const r=$e(o)-$e(s);return r!==0?r:(o.displayName||"").localeCompare(s.displayName||"","vi",{sensitivity:"base"})})}function le(e,t){if(!e||!t)return null;const o=H(e),s=zt(t);if(!s)return null;const r=o.members.get(s.id)||{},i={...r,...s,avatarText:s.avatarText||r.avatarText||F(s.displayName||""),lastSeen:s.lastSeen||r.lastSeen||Date.now()};return o.members.set(s.id,i),i}function rn(e,t){const o=b(e);return!o||!t?!1:o.members.delete(String(t))}function an(e,t){if(!e)return;const o=H(e);o.permissions={...o.permissions,...t}}function w(e){const t=b(e);return t?{...Q(),...t.permissions||{}}:Q()}function oe(e,t){const o=b(e);return!o||o.messageIds.has(t.id)?!1:(o.messageIds.add(t.id),o.messages.push(t),o.lastText=t.type==="text"?t.text:t.caption||t.text||"["+t.type+"]",o.lastDate=t.date,!0)}function cn(e,t){const o=b(e);if(!o)return!1;const s=o.messages.findIndex(r=>r.id===t);return s===-1?!1:(o.messages.splice(s,1),o.messageIds.delete(t),!0)}function H(e,t={}){let o=b(e);if(o)o=ve(o);else{const s={id:String(e),type:t.type||"unknown",title:t.title||"Chat "+e,avatarText:t.avatarText||(t.title?F(t.title):"?"),messages:[],messageIds:new Set,members:new Map,permissions:Q(),lastText:"",lastDate:0,unread:0,...t};Zt(e,s),o=b(e)}return o}const Be="tg_bot_chat_",lt="tg_bot_info_",dt="tg_last_update_id",de="tg_theme_preference",mt="tg_bot_stickers_";function x(e){if(!e)return null;const t=e.match(/^(\d+):/);return t?t[1]:null}function $(e,t){const o=x(e);if(!o)return!1;const s=Be+o;try{const r=Array.from(t.entries()).map(([i,c])=>{const l=c.members instanceof Map?Array.from(c.members.entries()):[];return[i,{...c,messageIds:Array.from(c.messageIds||[]),members:l,permissions:{...c.permissions||{}}}]});return localStorage.setItem(s,JSON.stringify(r)),!0}catch(r){return console.error("Failed to save chat history:",r),!1}}function ln(e){const t=x(e);if(!t)return new Map;const o=Be+t,s=localStorage.getItem(o);if(!s)return new Map;try{const r=JSON.parse(s);if(!Array.isArray(r))return new Map;const i=new Map;for(const[c,l]of r){const u=Array.isArray(l.members)?new Map(l.members.map(([f,d])=>[String(f),d])):new Map;i.set(c,{...l,messageIds:new Set(l.messageIds||[]),members:u,permissions:{...l.permissions||{}}})}return i}catch(r){return console.error("Failed to load chat history:",r),new Map}}function dn(e,t){const o=x(e);if(!o)return!1;const s=lt+o;try{return localStorage.setItem(s,JSON.stringify(t)),!0}catch(r){return console.error("Failed to save bot info:",r),!1}}function mn(e){const t=x(e);if(!t)return null;const o=lt+t,s=localStorage.getItem(o);if(!s)return null;try{return JSON.parse(s)}catch{return null}}function un(){const e=localStorage.getItem(dt);return e&&parseInt(e,10)||0}function pn(e){localStorage.setItem(dt,String(e))}function hn(e){const t=x(e);if(!t)return!1;const o=Be+t;return localStorage.removeItem(o),!0}function fn(e){e?localStorage.setItem(de,e):localStorage.removeItem(de)}function gn(){return localStorage.getItem(de)}function yn(e,t){const o=x(e);if(!o||!t||!t.file_id)return!1;const s=mt+o,r=ut(e);if(r.some(c=>c.file_id===t.file_id))return!0;const i=[t,...r].slice(0,100);try{return localStorage.setItem(s,JSON.stringify(i)),!0}catch(c){return console.error("Failed to save sticker:",c),!1}}function ut(e){const t=x(e);if(!t)return[];const o=mt+t,s=localStorage.getItem(o);if(!s)return[];try{const r=JSON.parse(s);return Array.isArray(r)?r:[]}catch{return[]}}const ie={en:{appTitle:"Telegram Bot",loading:"Loading...",saving:"Saving...",save:"Save",cancel:"Cancel",close:"Close",delete:"Delete",refresh:"Refresh",search:"Search",ok:"OK",yes:"Yes",no:"No",you:"You",user:"User",statusDisconnected:"Not connected (missing token)",statusConnecting:"Connecting...",statusConnected:"Receiving updates...",statusError:"Error: {error}",noChatSelected:"No chat selected",noConversations:"No conversations yet. When messages arrive, they will appear here.",enterChatId:"Enter chat ID or @username",openChat:"Open chat",enterMessage:"Type a message...",noConversationSelected:"No conversation selected",send:"Send",attach:"Attach",sticker:"Sticker",replyingTo:"Replying to:",cancelReply:"Cancel reply",newMessage:"‚Üì New message",deleteMessage:"Delete message",confirmDelete:"Are you sure you want to delete this message?",messageDeleted:"Message deleted",messageSendFailed:"Send failed: {error}",networkError:"Network error: {error}",photo:"Photo",file:"File",unsupportedContent:"[Cannot display this content type]",animatedSticker:"[Animated sticker]",settingsTitle:"Settings",botConnection:"Bot Connection",botToken:"Bot Token (botXXXXXXXX:YYYYYYYYYYYYYYYY)",corsProxy:"CORS proxy prefix (optional, e.g.: https://cors.isomorphic-git.org/)",testConnection:"Test",deleteWebhook:"Delete webhook",enableNotifications:"Enable notifications",saveAndConnect:"Save & Connect",settingsHint:"If you get a 409 error while polling, delete the webhook. If you have CORS issues, add a proxy prefix.",enterToken:"‚ùå Enter Bot Token!",tokenMissing:"Token not found.",connectionOk:"‚úÖ OK: @{username} ‚Ä¢ id={id}",connectionNoUsername:"(no username)",connectionFailed:"‚ùå getMe error: {error}",connectionNetworkError:"‚ùå CORS or network error: {error}",webhookDeleted:"‚úÖ Webhook deleted.",webhookDeleteFailed:"‚ùå Could not delete: {error}",webhookDeleteNetworkError:"‚ùå Network error deleting webhook: {error}",notificationsGranted:"‚úÖ Notifications: permission granted.",notificationsDenied:"‚ùå Notifications: denied or not granted.",unknownError:"Unknown error",theme:"Theme",themeLight:"Light",themeDark:"Dark",themeSystem:"System",changeTheme:"Change theme",language:"Language",languageEnglish:"English",languageVietnamese:"Ti·∫øng Vi·ªát",botInfo:"Bot Information",botName:"Name:",botUsername:"Username:",botId:"Bot ID:",botDescription:"Description:",botShortDescription:"Short description:",botCommands:"Command list",botFeatures:"Supported features",noData:"‚Äî",featureThemes:"Light / dark / system theme",featurePushNotifications:"Push notifications for new messages",featureChatHistory:"Save chat history in browser",featureMemberManagement:"Member management & permissions",featureSendMessages:"Send text and media messages",preferences:"Preferences",prefAutoScroll:"Auto-scroll to new messages",prefSound:"Notification sound",prefPush:"Push notifications when tab is inactive",manageMembers:"Manage members",groupManagement:"Group Management",members:"Members",groupInfo:"Group Info",groupName:"Group name",groupDescription:"Description",groupPhoto:"Profile picture",saveChanges:"Save changes",loadingMembers:"Loading...",memberCount:"{count} members",memberInfo:"Member Information",memberName:"Name",memberUsername:"Username",memberId:"ID",memberStatus:"Status",memberJoined:"Joined",memberActions:"Member Actions",statusCreator:"Creator",statusAdministrator:"Administrator",statusModerator:"Moderator",statusMember:"Member",statusRestricted:"Restricted",statusLeft:"Left",statusKicked:"Kicked",promoteAdmin:"‚≠ê Promote to admin",promoteModerator:"üõ°Ô∏è Moderator",demoteToMember:"üë§ Member",kickUser:"üö´ Kick",copyId:"üìã Copy ID",copyUsername:"üìã Copy username",restrictUser:"üîí Restrict permissions",userActions:"User Actions",success:"‚úÖ Success",error:"‚ùå Error",warning:"‚ö†Ô∏è Warning",info:"‚ÑπÔ∏è Info",searching:"üîç Searching...",found:"‚úÖ Found",notFound:"‚ùå Not found",pleaseSelectChat:"Please select a chat first.",needToken:"You need to enter a token.",pleaseSelectConversation:"Please select a conversation.",enterChatIdOrUsername:"Please enter chat ID or username",searchingForUser:"Searching for @{username}",chatNotFound:"Chat does not exist or bot does not have access",searchError:"Error during search: {error}",idCopied:"ID copied to clipboard",usernameCopied:"Username copied to clipboard",memberKicked:"Member kicked",memberPromoted:"Member promoted",memberDemoted:"Member demoted",permissionDenied:"Permission denied",cannotDeleteMessage:"Cannot delete message (check bot permissions)",webhookActive:"Webhook is active. Delete webhook in Settings.",getUpdatesError:"getUpdates error: {error}",corsError:"CORS or network error during getUpdates",chatAction:"typing...",groupSettingsSaved:"Group settings saved",groupSettingsFailed:"Failed to save group settings: {error}",selectFile:"No file or chat selected.",fileSendFailed:"File send failed: {error}",kickConfirm:"Are you sure you want to kick {name}?",promoteConfirm:"Promote {name} to administrator?",demoteConfirm:"Demote {name} to regular member?",closeStickerPanel:"Close",noStickers:"No stickers yet. Received stickers will appear here.",errorUnknown:"Unknown error",errorNetwork:"Network error",errorPermission:"Permission error",errorNotFound:"Not found"},vi:{appTitle:"Telegram Bot",loading:"ƒêang t·∫£i...",saving:"ƒêang l∆∞u...",save:"L∆∞u",cancel:"H·ªßy",close:"ƒê√≥ng",delete:"X√≥a",refresh:"L√†m m·ªõi",search:"T√¨m ki·∫øm",ok:"OK",yes:"C√≥",no:"Kh√¥ng",you:"B·∫°n",user:"Ng∆∞·ªùi d√πng",statusDisconnected:"Ch∆∞a k·∫øt n·ªëi (thi·∫øu token)",statusConnecting:"ƒêang k·∫øt n·ªëi...",statusConnected:"ƒêang nh·∫≠n c·∫≠p nh·∫≠t...",statusError:"L·ªói: {error}",noChatSelected:"Ch∆∞a ch·ªçn cu·ªôc tr√≤ chuy·ªán",noConversations:"Ch∆∞a c√≥ cu·ªôc tr√≤ chuy·ªán. Khi c√≥ tin nh·∫Øn ƒë·∫øn, m·ª•c s·∫Ω hi·ªán ·ªü ƒë√¢y.",enterChatId:"Nh·∫≠p chat ID ho·∫∑c @username",openChat:"M·ªü chat",enterMessage:"Nh·∫≠p tin nh·∫Øn...",noConversationSelected:"Ch∆∞a ch·ªçn cu·ªôc tr√≤ chuy·ªán",send:"G·ª≠i",attach:"ƒê√≠nh k√®m",sticker:"Sticker",replyingTo:"ƒêang tr·∫£ l·ªùi:",cancelReply:"H·ªßy tr·∫£ l·ªùi",newMessage:"‚Üì Tin m·ªõi",deleteMessage:"X√≥a tin nh·∫Øn",confirmDelete:"B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a tin nh·∫Øn n√†y?",messageDeleted:"ƒê√£ x√≥a tin nh·∫Øn",messageSendFailed:"G·ª≠i th·∫•t b·∫°i: {error}",networkError:"L·ªói m·∫°ng: {error}",photo:"·∫¢nh",file:"T·ªáp",unsupportedContent:"[Kh√¥ng hi·ªÉn th·ªã lo·∫°i n·ªôi dung n√†y]",animatedSticker:"[Sticker ƒë·ªông]",settingsTitle:"Trung t√¢m c√†i ƒë·∫∑t",botConnection:"K·∫øt n·ªëi bot",botToken:"Bot Token (botXXXXXXXX:YYYYYYYYYYYYYYYY)",corsProxy:"CORS proxy prefix (tu·ª≥ ch·ªçn, vd: https://cors.isomorphic-git.org/)",testConnection:"Ki·ªÉm tra",deleteWebhook:"X√≥a webhook",enableNotifications:"B·∫≠t th√¥ng b√°o",saveAndConnect:"L∆∞u & K·∫øt n·ªëi",settingsHint:"N·∫øu nh·∫≠n l·ªói 409 khi polling, h√£y x√≥a webhook. N·∫øu b·ªã CORS, th√™m proxy prefix.",enterToken:"‚ùå Nh·∫≠p Bot Token!",tokenMissing:"Ch∆∞a c√≥ token.",connectionOk:"‚úÖ OK: @{username} ‚Ä¢ id={id}",connectionNoUsername:"(kh√¥ng t√™n)",connectionFailed:"‚ùå L·ªói getMe: {error}",connectionNetworkError:"‚ùå CORS ho·∫∑c m·∫°ng l·ªói: {error}",webhookDeleted:"‚úÖ ƒê√£ x√≥a webhook.",webhookDeleteFailed:"‚ùå Kh√¥ng x√≥a ƒë∆∞·ª£c: {error}",webhookDeleteNetworkError:"‚ùå L·ªói m·∫°ng khi x√≥a webhook: {error}",notificationsGranted:"‚úÖ Th√¥ng b√°o: ƒë√£ c·∫•p quy·ªÅn.",notificationsDenied:"‚ùå Th√¥ng b√°o: b·ªã t·ª´ ch·ªëi ho·∫∑c ch∆∞a c·∫•p.",unknownError:"Kh√¥ng r√µ",theme:"Giao di·ªán",themeLight:"S√°ng",themeDark:"T·ªëi",themeSystem:"H·ªá th·ªëng",changeTheme:"ƒê·ªïi giao di·ªán",language:"Ng√¥n ng·ªØ",languageEnglish:"English",languageVietnamese:"Ti·∫øng Vi·ªát",botInfo:"Th√¥ng tin bot",botName:"T√™n:",botUsername:"Username:",botId:"Bot ID:",botDescription:"M√¥ t·∫£:",botShortDescription:"M√¥ t·∫£ ng·∫Øn:",botCommands:"Danh s√°ch l·ªánh",botFeatures:"T√≠nh nƒÉng h·ªó tr·ª£",noData:"‚Äî",featureThemes:"Giao di·ªán s√°ng / t·ªëi / h·ªá th·ªëng",featurePushNotifications:"Th√¥ng b√°o ƒë·∫©y khi c√≥ tin nh·∫Øn m·ªõi",featureChatHistory:"L∆∞u l·ªãch s·ª≠ h·ªôi tho·∫°i trong tr√¨nh duy·ªát",featureMemberManagement:"Qu·∫£n l√Ω th√†nh vi√™n & ch·ªânh s·ª≠a quy·ªÅn",featureSendMessages:"G·ª≠i tin nh·∫Øn vƒÉn b·∫£n v√† media",preferences:"T√πy ch·ªçn",prefAutoScroll:"T·ª± ƒë·ªông cu·ªôn ƒë·∫øn tin m·ªõi",prefSound:"√Çm b√°o th√¥ng b√°o",prefPush:"Th√¥ng b√°o ƒë·∫©y khi tab kh√¥ng ho·∫°t ƒë·ªông",manageMembers:"Qu·∫£n l√Ω th√†nh vi√™n",groupManagement:"Qu·∫£n l√Ω nh√≥m",members:"Th√†nh vi√™n",groupInfo:"Th√¥ng tin nh√≥m",groupName:"T√™n nh√≥m",groupDescription:"M√¥ t·∫£",groupPhoto:"·∫¢nh ƒë·∫°i di·ªán",saveChanges:"L∆∞u thay ƒë·ªïi",loadingMembers:"ƒêang t·∫£i...",memberCount:"{count} th√†nh vi√™n",memberInfo:"Th√¥ng tin th√†nh vi√™n",memberName:"T√™n",memberUsername:"Username",memberId:"ID",memberStatus:"Tr·∫°ng th√°i",memberJoined:"Tham gia",memberActions:"T√°c v·ª•",statusCreator:"Ch·ªß nh√≥m",statusAdministrator:"Qu·∫£n tr·ªã vi√™n",statusModerator:"Ng∆∞·ªùi ki·ªÉm duy·ªát",statusMember:"Th√†nh vi√™n",statusRestricted:"B·ªã h·∫°n ch·∫ø",statusLeft:"ƒê√£ r·ªùi",statusKicked:"ƒê√£ b·ªã kick",promoteAdmin:"‚≠ê ThƒÉng admin",promoteModerator:"üõ°Ô∏è Moderator",demoteToMember:"üë§ Th√†nh vi√™n",kickUser:"üö´ Kick",copyId:"üìã Copy ID",copyUsername:"üìã Copy username",restrictUser:"üîí H·∫°n ch·∫ø quy·ªÅn",userActions:"T√°c v·ª• v·ªõi ng∆∞·ªùi d√πng",success:"‚úÖ Th√†nh c√¥ng",error:"‚ùå L·ªói",warning:"‚ö†Ô∏è Ch√∫ √Ω",info:"‚ÑπÔ∏è Th√¥ng tin",searching:"üîç ƒêang t√¨m...",found:"‚úÖ T√¨m th·∫•y",notFound:"‚ùå Kh√¥ng t√¨m th·∫•y",pleaseSelectChat:"Ch·ªçn chat tr∆∞·ªõc.",needToken:"B·∫°n c·∫ßn nh·∫≠p token.",pleaseSelectConversation:"H√£y ch·ªçn cu·ªôc tr√≤ chuy·ªán.",enterChatIdOrUsername:"Vui l√≤ng nh·∫≠p chat ID ho·∫∑c username",searchingForUser:"ƒêang t√¨m @{username}",chatNotFound:"Chat kh√¥ng t·ªìn t·∫°i ho·∫∑c bot ch∆∞a c√≥ quy·ªÅn truy c·∫≠p",searchError:"L·ªói khi t√¨m ki·∫øm: {error}",idCopied:"ƒê√£ copy ID",usernameCopied:"ƒê√£ copy username",memberKicked:"ƒê√£ kick th√†nh vi√™n",memberPromoted:"ƒê√£ thƒÉng ch·ª©c",memberDemoted:"ƒê√£ h·∫° ch·ª©c",permissionDenied:"Kh√¥ng ƒë·ªß quy·ªÅn",cannotDeleteMessage:"Kh√¥ng th·ªÉ x√≥a tin nh·∫Øn (ki·ªÉm tra quy·ªÅn c·ªßa bot)",webhookActive:"Webhook ƒëang ho·∫°t ƒë·ªông. X√≥a webhook trong C√†i ƒë·∫∑t.",getUpdatesError:"L·ªói getUpdates: {error}",corsError:"CORS ho·∫∑c m·∫°ng l·ªói khi getUpdates",chatAction:"ƒëang nh·∫≠p...",groupSettingsSaved:"ƒê√£ l∆∞u c√†i ƒë·∫∑t nh√≥m",groupSettingsFailed:"Kh√¥ng th·ªÉ l∆∞u c√†i ƒë·∫∑t nh√≥m: {error}",selectFile:"Ch∆∞a ch·ªçn chat ho·∫∑c t·ªáp.",fileSendFailed:"G·ª≠i file th·∫•t b·∫°i: {error}",kickConfirm:"B·∫°n c√≥ ch·∫Øc mu·ªën kick {name}?",promoteConfirm:"ThƒÉng {name} l√™n qu·∫£n tr·ªã vi√™n?",demoteConfirm:"H·∫° {name} xu·ªëng th√†nh vi√™n th∆∞·ªùng?",closeStickerPanel:"ƒê√≥ng",noStickers:"Ch∆∞a c√≥ sticker. Sticker nh·∫≠n ƒë∆∞·ª£c s·∫Ω hi·ªán ·ªü ƒë√¢y.",errorUnknown:"L·ªói kh√¥ng x√°c ƒë·ªãnh",errorNetwork:"L·ªói m·∫°ng",errorPermission:"L·ªói quy·ªÅn",errorNotFound:"Kh√¥ng t√¨m th·∫•y"}},pt="tg_language",j="en",ht=["en","vi"];let P=j;function En(){return(navigator.language||navigator.userLanguage||"").toLowerCase().startsWith("vi")?"vi":"en"}function bn(){const e=localStorage.getItem(pt);return e&&ht.includes(e)?e:En()}function vn(){return P=bn(),ft(P),P}function kn(){return P}function Bn(e){return ht.includes(e)||(console.warn(`Language ${e} not supported, falling back to ${j}`),e=j),P=e,ft(e),e}function ft(e){try{localStorage.setItem(pt,e)}catch(t){console.warn("Failed to save language preference:",t)}}function a(e,t={}){let s=(ie[P]||ie[j])[e]||ie[j][e]||e;return Object.keys(t).forEach(r=>{const i=`{${r}}`;s=s.replace(new RegExp(i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),t[r])}),s}function W(e,t,o,s={}){const r=e.side==="right",i=r||s.canDeleteOthers,c=document.createElement("div");if(c.className="message "+(r?"right":"left")+(e.reply_to?" reply":""),c.dataset.msgId=e.id,i){const d=document.createElement("div");d.className="msg-actions";const p=document.createElement("button");p.className="msg-action-btn",p.textContent="üóëÔ∏è",p.title=a("deleteMessage"),p.addEventListener("click",h=>{h.stopPropagation(),o&&o(e.id)}),d.appendChild(p),c.appendChild(d)}if(e.reply_preview){const d=document.createElement("div");d.className="reply-to",d.textContent="‚Ü™ "+e.reply_preview,c.appendChild(d)}const l=document.createElement("div");if(e.type==="photo"){const d=document.createElement("img");if(d.src=e.mediaUrl,d.className="media",d.alt=e.caption||a("photo"),l.appendChild(d),e.caption){const p=document.createElement("div");p.textContent=e.caption,p.style.marginTop="6px",l.appendChild(p)}}else if(e.type==="video"){const d=document.createElement("video");if(d.src=e.mediaUrl,d.controls=!0,d.playsInline=!0,d.className="media",l.appendChild(d),e.caption){const p=document.createElement("div");p.textContent=e.caption,p.style.marginTop="6px",l.appendChild(p)}}else if(e.type==="audio"||e.type==="voice"){const d=document.createElement("audio");if(d.src=e.mediaUrl,d.controls=!0,d.className="media",l.appendChild(d),e.caption){const p=document.createElement("div");p.textContent=e.caption,p.style.marginTop="6px",l.appendChild(p)}}else if(e.type==="document"){const d=document.createElement("a");if(d.href=e.mediaUrl,d.target="_blank",d.rel="noopener noreferrer",d.className="doc-link",d.textContent=e.fileName||a("file"),l.appendChild(d),e.caption){const p=document.createElement("div");p.textContent=e.caption,p.style.marginTop="6px",l.appendChild(p)}}else e.type==="sticker"?Cn(l,e):l.textContent=e.text;c.appendChild(l);const u=document.createElement("div");u.className="meta";const f=document.createElement("span");f.className="sender-name",f.textContent=e.fromName,s.isGroupChat&&s.onUserClick&&(f.style.cursor="pointer",f.style.textDecoration="underline",f.addEventListener("click",d=>{d.stopPropagation(),s.onUserClick(e.fromId,e.fromName,e.fromUsername)})),u.appendChild(f),u.appendChild(document.createTextNode(` ‚Ä¢ ${Xt(e.date)}`)),c.appendChild(u),t.appendChild(c)}function Cn(e,t){if(t.stickerFormat==="webp"||t.stickerFormat==="static"){const o=document.createElement("img");o.src=t.mediaUrl,o.className="media sticker-image",o.alt=t.emoji||"Sticker",o.style.maxWidth="150px",o.style.maxHeight="150px",o.style.objectFit="contain",e.appendChild(o)}else if(t.stickerFormat==="webm"||t.stickerFormat==="video"){const o=document.createElement("video");o.src=t.mediaUrl,o.autoplay=!0,o.loop=!0,o.muted=!0,o.playsInline=!0,o.className="media sticker-video",o.style.maxWidth="150px",o.style.maxHeight="150px",o.style.objectFit="contain",e.appendChild(o)}else if(t.stickerFormat==="tgs"||t.stickerFormat==="animated"){const o=document.createElement("div");o.className="sticker-placeholder",o.style.fontSize="3rem",o.style.textAlign="center",o.style.padding="10px",o.textContent=t.emoji||"‚ú®",e.appendChild(o);const s=document.createElement("div");s.className="sticker-note",s.style.fontSize="0.75rem",s.style.color="var(--muted)",s.style.marginTop="4px",s.style.textAlign="center",s.textContent=a("animatedSticker"),e.appendChild(s)}else{const o=document.createElement("div");o.textContent="[Sticker] "+(t.emoji||""),e.appendChild(o)}}function D(e,t,o,s,r,i){s.innerHTML="";const c=Array.from(e.values()).sort((u,f)=>(f.lastDate||0)-(u.lastDate||0));if(s.querySelectorAll(".chat-item").forEach(u=>u.remove()),!c.length){o&&(o.style.display="block");return}o&&(o.style.display="none");for(const u of c){const f=document.createElement("div");f.className="chat-item"+(u.id===t?" active":""),f.dataset.chatId=u.id,f.innerHTML=`
      <div class="avatar">${u.avatarText}</div>
      <div class="info">
        <div class="name">${u.title}</div>
        <div class="last">${u.lastText?ne(u.lastText):"‚Äî"}</div>
      </div>
      <div class="badge${u.unread?"":" hidden"}">${u.unread||""}</div>
      <button class="delete-chat-btn" title="X√≥a chat">üóëÔ∏è</button>
    `,f.addEventListener("click",p=>{p.target.closest(".delete-chat-btn")||r(u.id)});const d=f.querySelector(".delete-chat-btn");d&&d.addEventListener("click",p=>{p.stopPropagation(),i&&confirm(`X√≥a chat "${u.title}"?`)&&i(u.id)}),s.appendChild(f)}}function me(e,t,o,s={}){if(t.innerHTML="",!(!e||!e.messages))for(const r of e.messages)W(r,t,o,s)}function In(e){e&&(e.innerHTML="")}function Z(e,t,o){t&&(t.textContent=(e==null?void 0:e.title)||"Ch∆∞a ch·ªçn cu·ªôc tr√≤ chuy·ªán"),o&&(e?(o.textContent=e.avatarText||"?",o.style.display="grid"):o.style.display="none")}function gt(e,t){t&&(e&&(e.type==="group"||e.type==="supergroup")?t.style.display="block":t.style.display="none")}function Ce(e,t){if(!e||!t)return;t.scrollTop+t.clientHeight>=t.scrollHeight-20||(e.style.display="block")}function _n(e,t,o){if(t){if(t.innerHTML="",!e||e.length===0){const s=document.createElement("div");s.className="stickers-empty",s.textContent="Ch∆∞a c√≥ sticker n√†o",t.appendChild(s);return}e.forEach(s=>{const r=document.createElement("div");if(r.className="sticker-item",r.title=s.emoji||"Sticker",s.file_id&&s.url)if(s.is_animated)r.innerHTML=`<div class="sticker-thumb">${s.emoji||"‚ú®"}</div>`;else if(s.is_video){const i=document.createElement("video");i.src=s.url,i.autoplay=!0,i.loop=!0,i.muted=!0,i.playsInline=!0,i.className="sticker-thumb",r.appendChild(i)}else{const i=document.createElement("img");i.src=s.url,i.alt=s.emoji||"Sticker",i.className="sticker-thumb",r.appendChild(i)}else r.innerHTML=`<div class="sticker-thumb">${s.emoji||"‚ùì"}</div>`;r.addEventListener("click",()=>{o&&o(s)}),t.appendChild(r)})}}const Mn=()=>document.getElementById("chatList"),Sn=()=>document.getElementById("emptyNotice"),wn=()=>document.getElementById("messages"),Tn=()=>document.getElementById("newMsgBtn"),Ln=()=>document.getElementById("input"),xn=()=>document.getElementById("sendBtn"),Dn=()=>document.getElementById("attachBtn"),Nn=()=>document.getElementById("stickerBtn"),Un=()=>document.getElementById("fileInput"),An=()=>document.getElementById("replyContext"),Pn=()=>document.getElementById("replyText"),On=()=>document.getElementById("cancelReply"),Fn=()=>document.getElementById("stickerPanel"),Rn=()=>document.getElementById("closeStickerBtn"),Hn=()=>document.getElementById("stickerList"),$n=()=>document.getElementById("userActionsMenu"),Kn=()=>document.getElementById("userActionsTitle"),Yn=()=>document.getElementById("closeUserActionsBtn"),jn=()=>document.getElementById("copyIdBtn"),Gn=()=>document.getElementById("copyUsernameBtn"),Wn=()=>document.getElementById("kickUserBtn"),Xn=()=>document.getElementById("promoteUserBtn"),qn=()=>document.getElementById("moderateUserBtn"),Vn=()=>document.getElementById("demoteUserBtn"),Jn=()=>document.getElementById("restrictUserBtn"),zn=()=>document.getElementById("status"),Qn=()=>document.getElementById("botInfo"),Zn=()=>document.getElementById("headerTitle"),eo=()=>document.getElementById("activeAvatar"),to=()=>document.getElementById("themeToggleBtn"),no=()=>document.getElementById("sidebar"),oo=()=>document.getElementById("menuToggle"),so=()=>document.getElementById("sidebarCloseBtn"),ro=()=>document.getElementById("openChatInput"),io=()=>document.getElementById("openChatBtn"),ao=()=>document.getElementById("membersBtn"),co=()=>document.getElementById("membersOverlay"),lo=()=>document.getElementById("membersList"),mo=()=>document.getElementById("closeMembersBtn"),uo=()=>document.getElementById("groupInfo"),po=()=>document.getElementById("membersHint"),ho=()=>document.getElementById("overlay"),fo=()=>document.getElementById("settingsBtn"),go=()=>document.getElementById("saveBtn"),yo=()=>document.getElementById("cancelBtn"),Eo=()=>document.getElementById("tokenInput"),bo=()=>document.getElementById("proxyInput"),vo=()=>document.getElementById("testBtn"),ko=()=>document.getElementById("deleteWebhookBtn"),Bo=()=>document.getElementById("settingsHint"),Co=()=>document.getElementById("notifBtn"),Io=()=>document.getElementById("themeOptionLight"),_o=()=>document.getElementById("themeOptionDark"),Mo=()=>document.getElementById("themeOptionSystem"),So=()=>document.getElementById("langOptionEn"),wo=()=>document.getElementById("langOptionVi"),To=()=>document.getElementById("botDetailName"),Lo=()=>document.getElementById("botDetailUsername"),xo=()=>document.getElementById("botDetailId"),Do=()=>document.getElementById("botDetailDescription"),No=()=>document.getElementById("botDetailShortDescription"),Uo=()=>document.getElementById("botCommandsList"),Ao=()=>document.getElementById("botFeatureList"),Po=()=>document.getElementById("prefAutoScroll"),Oo=()=>document.getElementById("prefSound"),Fo=()=>document.getElementById("prefPush"),Ro=()=>document.getElementById("membersTabBtn"),Ho=()=>document.getElementById("groupTabBtn"),$o=()=>document.getElementById("membersTab"),Ko=()=>document.getElementById("groupSettingsTab"),Yo=()=>document.getElementById("refreshMembersBtn"),jo=()=>document.getElementById("groupNameInput"),Go=()=>document.getElementById("groupDescriptionInput"),Wo=()=>document.getElementById("groupPhotoInput"),Xo=()=>document.getElementById("saveGroupBtn"),qo=()=>document.getElementById("memberModal"),Vo=()=>document.getElementById("memberModalAvatar"),Jo=()=>document.getElementById("memberModalName"),zo=()=>document.getElementById("memberModalUsername"),Qo=()=>document.getElementById("memberModalId"),Zo=()=>document.getElementById("memberModalStatus"),es=()=>document.getElementById("memberModalJoined"),ts=()=>document.getElementById("memberPromoteBtn"),ns=()=>document.getElementById("memberModeratorBtn"),os=()=>document.getElementById("memberDemoteBtn"),ss=()=>document.getElementById("memberRestrictBtn"),rs=()=>document.getElementById("memberKickBtn"),is=()=>document.getElementById("closeMemberModalBtn"),as=()=>document.getElementById("restrictModal"),cs=()=>document.getElementById("closeRestrictModalBtn"),ls=()=>document.getElementById("applyRestrictBtn"),ds=()=>document.getElementById("permSendMessages"),ms=()=>document.getElementById("permSendMedia"),us=()=>document.getElementById("permSendPolls"),ps=()=>document.getElementById("permSendOther"),hs=()=>document.getElementById("permAddWebPage"),fs=()=>document.getElementById("permChangeInfo"),gs=()=>document.getElementById("permInviteUsers"),ys=()=>document.getElementById("permPinMessages"),Es=()=>document.getElementById("toasts");function bs(){return{chatListEl:Mn(),emptyNoticeEl:Sn(),messagesEl:wn(),newMsgBtn:Tn(),inputEl:Ln(),sendBtn:xn(),attachBtn:Dn(),fileInputEl:Un(),replyContext:An(),replyText:Pn(),cancelReply:On(),statusEl:zn(),botInfoEl:Qn(),headerTitleEl:Zn(),activeAvatarEl:eo(),themeToggleBtn:to(),sidebarEl:no(),menuToggleEl:oo(),sidebarCloseBtn:so(),openChatInputEl:ro(),openChatBtnEl:io(),membersBtnEl:ao(),membersOverlayEl:co(),membersListEl:lo(),closeMembersBtn:mo(),groupInfoEl:uo(),membersHintEl:po(),membersTabBtn:Ro(),groupTabBtn:Ho(),membersTabPanel:$o(),groupSettingsTab:Ko(),refreshMembersBtn:Yo(),groupNameInputEl:jo(),groupDescriptionInputEl:Go(),groupPhotoInputEl:Wo(),saveGroupBtn:Xo(),memberModalEl:qo(),memberModalAvatarEl:Vo(),memberModalNameEl:Jo(),memberModalUsernameEl:zo(),memberModalIdEl:Qo(),memberModalStatusEl:Zo(),memberModalJoinedEl:es(),memberPromoteBtn:ts(),memberModeratorBtn:ns(),memberDemoteBtn:os(),memberRestrictBtn:ss(),memberKickBtn:rs(),closeMemberModalBtn:is(),restrictModalEl:as(),closeRestrictModalBtn:cs(),applyRestrictBtn:ls(),permSendMessagesEl:ds(),permSendMediaEl:ms(),permSendPollsEl:us(),permSendOtherEl:ps(),permAddWebPageEl:hs(),permChangeInfoEl:fs(),permInviteUsersEl:gs(),permPinMessagesEl:ys(),overlayEl:ho(),settingsBtn:fo(),saveBtn:go(),cancelBtn:yo(),tokenInputEl:Eo(),proxyInputEl:bo(),testBtn:vo(),deleteWebhookBtn:ko(),settingsHintEl:Bo(),notifBtn:Co(),themeOptionLight:Io(),themeOptionDark:_o(),themeOptionSystem:Mo(),langOptionEn:So(),langOptionVi:wo(),botDetailNameEl:To(),botDetailUsernameEl:Lo(),botDetailIdEl:xo(),botDetailDescriptionEl:Do(),botDetailShortDescriptionEl:No(),botCommandsListEl:Uo(),botFeatureListEl:Ao(),prefAutoScrollEl:Po(),prefSoundEl:Oo(),prefPushEl:Fo(),toastsEl:Es(),stickerBtn:Nn(),stickerPanel:Fn(),closeStickerBtn:Rn(),stickerList:Hn(),userActionsMenu:$n(),userActionsTitle:Kn(),closeUserActionsBtn:Yn(),copyIdBtn:jn(),copyUsernameBtn:Gn(),kickUserBtn:Wn(),promoteUserBtn:Xn(),moderateUserBtn:qn(),demoteUserBtn:Vn(),restrictUserBtn:Jn()}}let q=null,ae=null,U=[],Y=null,Ke=50;function Ie(){return typeof window<"u"&&"Notification"in window}async function _e(){return"serviceWorker"in navigator?q||(ae||(ae=navigator.serviceWorker.register("/sw.js").then(e=>(q=e,e)).catch(e=>(console.warn("Service worker registration failed:",e),q=null,null))),ae):null}function g(e,t,o,s={}){if(!o)return;const r={id:Date.now(),title:e,body:t,timestamp:new Date,chatId:s.chatId,messageId:s.messageId};U.unshift(r),U.length>Ke&&(U=U.slice(0,Ke)),Y&&Y.remove();const i=document.createElement("div");i.className="toast compact",Y=i;const c=document.createElement("div");c.className="toast-content";const l=document.createElement("div");l.className="toast-title",l.textContent=e;const u=document.createElement("div");u.className="toast-body",u.textContent=t,c.appendChild(l),c.appendChild(u),i.appendChild(c);const f=document.createElement("button");f.className="toast-history-btn",f.textContent="üìã",f.title="Xem l·ªãch s·ª≠ th√¥ng b√°o",f.addEventListener("click",d=>{d.stopPropagation(),Cs(o)}),i.appendChild(f),s.chatId&&(i.style.cursor="pointer",i.addEventListener("click",()=>{s.scrollToMessage&&typeof s.scrollToMessage=="function"&&s.scrollToMessage(s.chatId,s.messageId)})),o.appendChild(i),setTimeout(()=>{Y===i&&(i.remove(),Y=null)},4e3)}async function vs(e,t,o,s={}){var i;const r=e.lastText||ne(t.text||t.caption||"["+(t.type||"tin nh·∫Øn")+"]");if(g(e.title,r,o,{chatId:e.id,messageId:t.id,scrollToMessage:s.scrollToMessage}),s.playSound!==!1&&Jt(),!!Ie()&&s.push!==!1&&document.hidden&&Notification.permission==="granted")try{const c={body:r,tag:`chat-${e.id}`,data:{chatId:e.id,messageId:t.id,url:((i=window==null?void 0:window.location)==null?void 0:i.href)||""}},l=await _e();l&&l.showNotification?l.showNotification(e.title,c):new Notification(e.title,c)}catch(c){console.warn("Kh√¥ng th·ªÉ hi·ªÉn th·ªã th√¥ng b√°o ƒë·∫©y:",c)}}async function ks(){if(!Ie())throw new Error("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Web Notifications");const e=await Notification.requestPermission();return e==="granted"&&await _e(),e}async function Bs(){return Ie()?_e():null}function Cs(e){if(!e)return;const t=document.getElementById("notificationHistoryModal");t&&t.remove();const o=document.createElement("div");o.id="notificationHistoryModal",o.className="overlay",o.innerHTML=`
    <div class="dialog dialog-large">
      <div class="dialog-header">
        <h3>L·ªãch s·ª≠ th√¥ng b√°o</h3>
        <button class="icon-btn close-history" title="ƒê√≥ng">‚úï</button>
      </div>
      <div class="notification-history">
        ${U.length===0?'<p class="empty-history">Ch∆∞a c√≥ th√¥ng b√°o n√†o</p>':""}
        ${U.map(s=>`
          <div class="history-item ${s.chatId?"clickable":""}" data-chat-id="${s.chatId||""}" data-message-id="${s.messageId||""}">
            <div class="history-header">
              <div class="history-title">${s.title}</div>
              <div class="history-time">${Is(s.timestamp)}</div>
            </div>
            <div class="history-body">${s.body}</div>
          </div>
        `).join("")}
      </div>
    </div>
  `,o.querySelector(".close-history").addEventListener("click",()=>o.remove()),o.addEventListener("click",s=>{s.target===o&&o.remove()}),o.querySelectorAll(".history-item.clickable").forEach(s=>{s.addEventListener("click",()=>{const r=s.dataset.chatId,i=s.dataset.messageId;r&&typeof window.scrollToMessage=="function"&&(window.scrollToMessage(r,i),o.remove())})}),document.body.appendChild(o)}function Is(e){const o=new Date-e,s=Math.floor(o/6e4),r=Math.floor(o/36e5),i=Math.floor(o/864e5);return s<1?"V·ª´a xong":s<60?`${s} ph√∫t tr∆∞·ªõc`:r<24?`${r} gi·ªù tr∆∞·ªõc`:i<7?`${i} ng√†y tr∆∞·ªõc`:e.toLocaleDateString("vi-VN")}const _s={can_manage_chat:!0,can_delete_messages:!0,can_manage_video_chats:!0,can_restrict_members:!0,can_promote_members:!0,can_change_info:!0,can_invite_users:!0,can_pin_messages:!0,is_anonymous:!1},Ms={can_manage_chat:!0,can_delete_messages:!0,can_manage_video_chats:!0,can_restrict_members:!0,can_promote_members:!1,can_change_info:!0,can_invite_users:!0,can_pin_messages:!0,is_anonymous:!1},Ss={can_manage_chat:!1,can_delete_messages:!1,can_manage_video_chats:!1,can_restrict_members:!1,can_promote_members:!1,can_change_info:!1,can_invite_users:!0,can_pin_messages:!1,is_anonymous:!1},ws={can_send_messages:!0,can_send_audios:!0,can_send_documents:!0,can_send_photos:!0,can_send_videos:!0,can_send_video_notes:!0,can_send_voice_notes:!0,can_send_polls:!0,can_send_other_messages:!0,can_add_web_page_previews:!0,can_change_info:!1,can_invite_users:!0,can_pin_messages:!1,can_manage_topics:!1};async function Ts(e){const t=await Pt(e);if(!t.ok)throw new Error(t.description||"Kh√¥ng th·ªÉ t·∫£i danh s√°ch qu·∫£n tr·ªã vi√™n");return t.result||[]}async function ce(e,t,o){const s=(o||"").toLowerCase();if(s==="admin"||s==="administrator")return re(e,t,_s);if(s==="moderator")return re(e,t,Ms);if(s==="member")return await re(e,t,Ss),Ft(e,t,ws);throw new Error("Vai tr√≤ kh√¥ng h·ª£p l·ªá: "+o)}async function Ls(e,t,o){return Ot(e,t)}async function xs(e,t){return Ht(e,t)}async function Ds(e,t){return $t(e,t)}async function Ns(e,t){return Kt(e,t)}function Us(e){switch((e||"").toLowerCase()){case"creator":return"üëë Ch·ªß nh√≥m";case"administrator":return"‚≠ê Qu·∫£n tr·ªã vi√™n";case"moderator":return"üõ°Ô∏è ƒêi·ªÅu h√†nh";default:return"üë§ Th√†nh vi√™n"}}let n=null,As=null,ue=null,V=!1;const ee={autoScroll:!0,sound:!0,push:!0};let C={...ee},G="system",L=null,yt="members";function Ps(){n=bs(),vn(),It(),L=window.matchMedia("(prefers-color-scheme: dark)"),L.addEventListener?L.addEventListener("change",Ye):L.addListener&&L.addListener(Ye);const e=gn();O(e||"system",!1),C=Ys(),bt(),Bs().catch(()=>{}),Ve(),window.addEventListener("resize",Ve);const t=localStorage.getItem("bot_token"),o=localStorage.getItem("cors_proxy")||"";if(t){rt(t),Je(t),ze(o);const s=ln(t);Qt(s);const r=localStorage.getItem("last_active_chat");r&&s.has(r)&&ke(r);const i=un();it(i);const c=mn(t);c&&(at(c),Mt()),_t()}else n.overlayEl.classList.remove("hidden");Os(),se()}function Os(){var e,t,o,s,r,i,c,l,u,f,d,p,h,B,_,X,Te,Le,xe,De,Ne,Ue,Ae,Pe,Oe,Fe,Re,He;n.settingsBtn.addEventListener("click",Fs),n.saveBtn.addEventListener("click",Rs),n.cancelBtn.addEventListener("click",Et),n.testBtn.addEventListener("click",Hs),n.deleteWebhookBtn.addEventListener("click",$s),n.notifBtn.addEventListener("click",Ks),(e=n.themeToggleBtn)==null||e.addEventListener("click",Gs),(t=n.themeOptionLight)==null||t.addEventListener("click",()=>O("light")),(o=n.themeOptionDark)==null||o.addEventListener("click",()=>O("dark")),(s=n.themeOptionSystem)==null||s.addEventListener("click",()=>O("system")),(r=n.langOptionEn)==null||r.addEventListener("click",()=>je("en")),(i=n.langOptionVi)==null||i.addEventListener("click",()=>je("vi")),(c=n.prefAutoScrollEl)==null||c.addEventListener("change",y=>J("autoScroll",y.target.checked)),(l=n.prefSoundEl)==null||l.addEventListener("change",y=>J("sound",y.target.checked)),(u=n.prefPushEl)==null||u.addEventListener("change",y=>J("push",y.target.checked)),(f=n.openChatBtnEl)==null||f.addEventListener("click",We),(d=n.openChatInputEl)==null||d.addEventListener("keydown",y=>{y.key==="Enter"&&We()}),n.menuToggleEl.addEventListener("click",()=>{n.sidebarEl.classList.toggle("hidden-mobile")}),(p=n.sidebarCloseBtn)==null||p.addEventListener("click",()=>{n.sidebarEl.classList.toggle("hidden-mobile")}),n.messagesEl.addEventListener("click",zs),n.newMsgBtn.addEventListener("click",()=>{R(n.messagesEl),n.newMsgBtn.style.display="none"}),n.sendBtn.addEventListener("click",Ge),n.inputEl.addEventListener("keydown",y=>{y.key==="Enter"&&!y.shiftKey&&(y.preventDefault(),Ge())}),n.inputEl.addEventListener("focus",sr),n.inputEl.addEventListener("blur",te),n.stickerBtn&&n.stickerBtn.addEventListener("click",ir),n.closeStickerBtn&&n.closeStickerBtn.addEventListener("click",wt),n.closeUserActionsBtn.addEventListener("click",z),n.copyIdBtn.addEventListener("click",()=>T("copyId")),n.copyUsernameBtn.addEventListener("click",()=>T("copyUsername")),n.kickUserBtn.addEventListener("click",()=>T("kick")),n.promoteUserBtn.addEventListener("click",()=>T("promote")),n.moderateUserBtn.addEventListener("click",()=>T("moderate")),n.demoteUserBtn.addEventListener("click",()=>T("demote")),n.restrictUserBtn.addEventListener("click",()=>T("restrict")),document.addEventListener("click",y=>{if(n.userActionsMenu&&!n.userActionsMenu.classList.contains("hidden")){const Tt=n.userActionsMenu.contains(y.target),Lt=y.target.classList.contains("sender-name");!Tt&&!Lt&&z()}}),document.addEventListener("keydown",y=>{(y.key==="Escape"||y.key==="Esc")&&n.userActionsMenu&&!n.userActionsMenu.classList.contains("hidden")&&z()}),n.attachBtn.addEventListener("click",()=>{if(!m){alert(a("pleaseSelectChat"));return}te(),n.fileInputEl.value="",n.fileInputEl.accept="*/*",n.fileInputEl.click()}),n.fileInputEl.addEventListener("change",()=>{const y=n.fileInputEl.files[0];y&&Zs(y)}),n.cancelReply.addEventListener("click",Se),n.membersBtnEl.addEventListener("click",er),n.closeMembersBtn.addEventListener("click",Xe),n.membersOverlayEl.addEventListener("click",y=>{y.target===n.membersOverlayEl&&Xe()}),(h=n.membersTabBtn)==null||h.addEventListener("click",()=>he("members")),(B=n.groupTabBtn)==null||B.addEventListener("click",()=>he("group")),(_=n.refreshMembersBtn)==null||_.addEventListener("click",()=>St(!0)),(X=n.saveGroupBtn)==null||X.addEventListener("click",nr),(Te=n.membersListEl)==null||Te.addEventListener("click",handleMemberListClick),(Le=n.chatListEl)==null||Le.addEventListener("contextmenu",handleChatListContextMenu),(xe=n.closeMemberModalBtn)==null||xe.addEventListener("click",closeMemberModal),(De=n.memberModalEl)==null||De.addEventListener("click",y=>{y.target===n.memberModalEl&&closeMemberModal()}),(Ne=n.memberPromoteBtn)==null||Ne.addEventListener("click",()=>changeMemberRole("admin")),(Ue=n.memberModeratorBtn)==null||Ue.addEventListener("click",()=>changeMemberRole("moderator")),(Ae=n.memberDemoteBtn)==null||Ae.addEventListener("click",()=>changeMemberRole("member")),(Pe=n.memberRestrictBtn)==null||Pe.addEventListener("click",openRestrictModal),(Oe=n.memberKickBtn)==null||Oe.addEventListener("click",kickMemberFromModal),(Fe=n.closeRestrictModalBtn)==null||Fe.addEventListener("click",closeRestrictModal),(Re=n.restrictModalEl)==null||Re.addEventListener("click",y=>{y.target===n.restrictModalEl&&closeRestrictModal()}),(He=n.applyRestrictBtn)==null||He.addEventListener("click",applyRestrictPermissions)}function se(){const e=b(m);if(D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),e){Z(e,n.headerTitleEl,n.activeAvatarEl),gt(e,n.membersBtnEl);const t=w(e.id);me(e,n.messagesEl,K,{canDeleteOthers:t.canDeleteMessages,isGroupChat:e.type==="group"||e.type==="supergroup",onUserClick:we}),C.autoScroll&&R(n.messagesEl)}else Z(null,n.headerTitleEl,n.activeAvatarEl),me(null,n.messagesEl)}function S(e){ke(e),localStorage.setItem("last_active_chat",e);const t=b(e);t?(t.unread=0,n.inputEl.disabled=!1,n.sendBtn.disabled=!1,n.attachBtn.disabled=!1,n.inputEl.placeholder=a("enterMessage"),n.inputEl.focus(),window.innerWidth<=768&&n.sidebarEl.classList.add("hidden-mobile")):(n.inputEl.disabled=!0,n.sendBtn.disabled=!0,n.attachBtn.disabled=!0,n.inputEl.placeholder=a("noConversationSelected")),n.newMsgBtn.style.display="none",se(),Js(e).catch(()=>{})}function Fs(){n.tokenInputEl.value=E,n.proxyInputEl.value=localStorage.getItem("cors_proxy")||"",n.overlayEl.classList.remove("hidden")}function Et(){n.overlayEl.classList.add("hidden")}function Rs(){const e=n.tokenInputEl.value.trim(),t=n.proxyInputEl.value.trim();if(!e){n.settingsHintEl.textContent=a("enterToken");return}e!==E&&(hn(E),on()),rt(e),Je(e),ze(t),localStorage.setItem("bot_token",e),t&&localStorage.setItem("cors_proxy",t),Et(),_t()}async function Hs(){if(!E){n.settingsHintEl.textContent=a("tokenMissing");return}try{const e=await nt();e.ok?n.settingsHintEl.textContent=a("connectionOk",{username:e.result.username||a("connectionNoUsername"),id:e.result.id}):n.settingsHintEl.textContent=a("connectionFailed",{error:e.description||a("unknownError")})}catch(e){n.settingsHintEl.textContent=a("connectionNetworkError",{error:e.message})}}async function $s(){if(E)try{const e=await Yt(!1);n.settingsHintEl.textContent=e.ok?a("webhookDeleted"):a("webhookDeleteFailed",{error:e.description||a("unknownError")})}catch(e){n.settingsHintEl.textContent=a("webhookDeleteNetworkError",{error:e.message})}}async function Ks(){try{const t=await ks()==="granted";n.settingsHintEl.textContent=a(t?"notificationsGranted":"notificationsDenied"),J("push",t)}catch(e){n.settingsHintEl.textContent=a("error")+": "+e.message}}function J(e,t,o=!0){e in ee&&(C={...C,[e]:t},o&&js(),bt())}function Ys(){try{const e=JSON.parse(localStorage.getItem("ui_preferences")||"{}");return{...ee,...e}}catch{return{...ee}}}function js(){try{localStorage.setItem("ui_preferences",JSON.stringify(C))}catch(e){console.warn("Kh√¥ng th·ªÉ l∆∞u tu·ª≥ ch·ªçn UI:",e)}}function bt(){n.prefAutoScrollEl&&(n.prefAutoScrollEl.checked=!!C.autoScroll),n.prefSoundEl&&(n.prefSoundEl.checked=!!C.sound),n.prefPushEl&&(n.prefPushEl.checked=!!C.push)}function vt(e){return e==="system"?L&&L.matches?"dark":"light":e}function O(e,t=!0){G=e,t&&fn(e);const o=vt(e);document.body.dataset.theme=o,document.body.dataset.themePreference=e,kt(e),Bt(o)}function kt(e){const t={light:n.themeOptionLight,dark:n.themeOptionDark,system:n.themeOptionSystem};Object.entries(t).forEach(([o,s])=>{s&&(o===e?s.classList.add("active"):s.classList.remove("active"))})}function Bt(e){n.themeToggleBtn&&(n.themeToggleBtn.textContent=e==="dark"?"üåô":"üåû")}function Gs(){const e=["light","dark","system"],t=e.indexOf(G),o=e[(t+1)%e.length];O(o)}function Ye(){G==="system"&&O("system",!1)}function je(e){Bn(e),It(),Ct(e),se()}function Ct(e){const t={en:n.langOptionEn,vi:n.langOptionVi};Object.entries(t).forEach(([o,s])=>{s&&(o===e?s.classList.add("active"):s.classList.remove("active"))})}function It(){document.querySelectorAll("[data-i18n]").forEach(t=>{const o=t.getAttribute("data-i18n");o&&(t.textContent=a(o))}),n.openChatInputEl&&(n.openChatInputEl.placeholder=a("enterChatId")),n.inputEl&&(m?n.inputEl.placeholder=a("enterMessage"):n.inputEl.placeholder=a("noConversationSelected")),n.tokenInputEl&&(n.tokenInputEl.placeholder=a("botToken")),n.proxyInputEl&&(n.proxyInputEl.placeholder=a("corsProxy")),n.settingsBtn&&(n.settingsBtn.title=a("settingsTitle"),n.settingsBtn.setAttribute("aria-label",a("settingsTitle"))),n.themeToggleBtn&&(n.themeToggleBtn.title=a("changeTheme"),n.themeToggleBtn.setAttribute("aria-label",a("changeTheme"))),n.openChatBtnEl&&(n.openChatBtnEl.title=a("openChat"),n.openChatBtnEl.setAttribute("aria-label",a("openChat"))),n.sendBtn&&(n.sendBtn.title=a("send"),n.sendBtn.setAttribute("aria-label",a("send"))),n.attachBtn&&(n.attachBtn.title=a("attach"),n.attachBtn.setAttribute("aria-label",a("attach"))),n.stickerBtn&&(n.stickerBtn.title=a("sticker"),n.stickerBtn.setAttribute("aria-label",a("sticker"))),n.membersBtnEl&&(n.membersBtnEl.title=a("manageMembers"),n.membersBtnEl.setAttribute("aria-label",a("manageMembers"))),n.cancelReply&&n.cancelReply.setAttribute("aria-label",a("cancelReply")),Ct(kn())}function Ws(){return[a("featureThemes"),a("featurePushNotifications"),a("featureChatHistory"),a("featureMemberManagement"),a("featureSendMessages")]}async function _t(){var e,t,o,s,r;if(!E){n.statusEl.textContent=a("statusDisconnected");return}n.statusEl.textContent=a("statusConnecting");try{const i=await nt();if(i.ok){const[c,l,u]=await Promise.allSettled([jt(),Gt(),Wt()]),f=c.status==="fulfilled"&&((e=c.value)!=null&&e.ok)?c.value.result||[]:[],d=l.status==="fulfilled"&&((t=l.value)!=null&&t.ok)&&((o=l.value.result)==null?void 0:o.description)||null,p=u.status==="fulfilled"&&((s=u.value)!=null&&s.ok)&&((r=u.value.result)==null?void 0:r.short_description)||null,h={id:i.result.id,username:i.result.username||null,name:[i.result.first_name,i.result.last_name].filter(Boolean).join(" ")||i.result.username||"Bot",commands:f,description:d,shortDescription:p};at(h),dn(E,h),Mt(),Xs()}else n.statusEl.textContent="L·ªói getMe: "+(i.description||"Kh√¥ng r√µ")}catch{n.statusEl.textContent="CORS ho·∫∑c m·∫°ng l·ªói khi getMe"}}function Mt(){const e=M;if(e.username?n.botInfoEl.textContent="@"+e.username:e.id?n.botInfoEl.textContent="Bot ID: "+e.id:n.botInfoEl.textContent="",n.botDetailNameEl&&(n.botDetailNameEl.textContent=e.name||"‚Äî"),n.botDetailUsernameEl&&(n.botDetailUsernameEl.textContent=e.username?"@"+e.username:"‚Äî"),n.botDetailIdEl&&(n.botDetailIdEl.textContent=e.id||"‚Äî"),n.botDetailDescriptionEl&&(n.botDetailDescriptionEl.textContent=e.description||"‚Äî"),n.botDetailShortDescriptionEl&&(n.botDetailShortDescriptionEl.textContent=e.shortDescription||"‚Äî"),n.botCommandsListEl)if(n.botCommandsListEl.innerHTML="",Array.isArray(e.commands)&&e.commands.length)e.commands.forEach(t=>{const o=document.createElement("li");o.textContent=`/${t.command}${t.description?" ‚Äî "+t.description:""}`,n.botCommandsListEl.appendChild(o)});else{const t=document.createElement("li");t.textContent="Kh√¥ng c√≥ l·ªánh m·∫∑c ƒë·ªãnh",n.botCommandsListEl.appendChild(t)}n.botFeatureListEl&&(n.botFeatureListEl.innerHTML="",Ws().forEach(t=>{const o=document.createElement("li");o.textContent=t,n.botFeatureListEl.appendChild(o)})),kt(G),Bt(vt(G))}function Xs(){clearInterval(As),V=!0,pe(),n.statusEl.textContent="ƒêang nh·∫≠n c·∫≠p nh·∫≠t..."}async function pe(){if(V)try{await qs(),setTimeout(()=>{V&&pe()},1e3)}catch(e){console.error("Polling error:",e),setTimeout(()=>{V&&pe()},2e3)}}async function qs(){try{const e=await xt(be||void 0);if(!e.ok){n.statusEl.textContent=a("getUpdatesError",{error:e.description||a("unknownError")}),String(e.error_code)==="409"&&(n.statusEl.textContent=a("webhookActive"));return}for(const t of e.result||[]){it(t.update_id+1),pn(t.update_id+1);const o=t.message||t.edited_message||t.channel_post||t.edited_channel_post;!o||!o.chat||await Vs(o)}n.statusEl.textContent=a("statusConnected")}catch(e){throw n.statusEl.textContent=a("corsError"),e}}async function Vs(e){const t=e.chat,o=String(t.id),r=t.type==="private"?[t.first_name,t.last_name].filter(Boolean).join(" ")||t.username||a("user"):t.title||t.type||"Chat",i=H(o,{type:t.type,title:r,avatarText:F(r)});t.title&&t.title!==i.title&&(i.title=t.title,i.avatarText=F(t.title),m===o&&Z(i,n.headerTitleEl,n.activeAvatarEl)),t.type&&t.type!==i.type&&(i.type=t.type);const c=(e.date||Math.floor(Date.now()/1e3))*1e3;e.from&&le(o,{id:e.from.id,first_name:e.from.first_name,last_name:e.from.last_name,username:e.from.username,isBot:e.from.is_bot,status:e.from.is_bot?"bot":"member",lastSeen:c}),Array.isArray(e.new_chat_members)&&e.new_chat_members.length&&e.new_chat_members.forEach(h=>{le(o,{id:h.id,first_name:h.first_name,last_name:h.last_name,username:h.username,isBot:h.is_bot,status:h.is_bot?"bot":"member",joinedDate:c,lastSeen:c})}),e.left_chat_member&&rn(o,e.left_chat_member.id);const l=m===o,u=l?Ee(n.messagesEl):!1,f=e.from&&M.id&&e.from.id===M.id,d={id:e.message_id,side:f?"right":"left",date:c,fromId:e.from?e.from.id:null,fromName:qt(e),fromUsername:Vt(e),reply_to:e.reply_to_message&&e.reply_to_message.message_id,reply_preview:e.reply_to_message&&ne(e.reply_to_message.text||e.reply_to_message.caption||"")};let p;if(e.text)p={...d,type:"text",text:e.text};else if(e.photo){const h=e.photo[e.photo.length-1],B=await I(h.file_id);p={...d,type:"photo",mediaUrl:B,caption:e.caption||""}}else if(e.video){const h=await I(e.video.file_id);p={...d,type:"video",mediaUrl:h,caption:e.caption||""}}else if(e.audio){const h=await I(e.audio.file_id);p={...d,type:"audio",mediaUrl:h,caption:e.caption||""}}else if(e.voice){const h=await I(e.voice.file_id);p={...d,type:"voice",mediaUrl:h,caption:e.caption||""}}else if(e.document){const h=await I(e.document.file_id);p={...d,type:"document",mediaUrl:h,caption:e.caption||"",fileName:e.document.file_name||"T·ªáp"}}else if(e.sticker){const h=e.sticker;let B="tgs",_="";h.is_video?(B="webm",_=await I(h.file_id)):h.is_animated||(B="webp",_=await I(h.file_id));const X={file_id:h.file_id,url:_,emoji:h.emoji||"",is_animated:h.is_animated,is_video:h.is_video,set_name:h.set_name,width:h.width,height:h.height};yn(E,X),p={...d,type:"sticker",mediaUrl:_,stickerFormat:B,emoji:h.emoji||""}}else p={...d,type:"text",text:a("unsupportedContent")};if(oe(o,p)){if(l){const h=w(o),B=b(o),_=B&&(B.type==="group"||B.type==="supergroup");W(p,n.messagesEl,K,{canDeleteOthers:h.canDeleteMessages,isGroupChat:_,onUserClick:we}),C.autoScroll&&u?(R(n.messagesEl),n.newMsgBtn.style.display="none"):Ce(n.newMsgBtn,n.messagesEl)}else i.unread=(i.unread||0)+1,vs(i,p,n.toastsEl,{playSound:C.sound,push:C.push,scrollToMessage:window.scrollToMessage});D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),l&&gt(i,n.membersBtnEl),$(E,v)}}async function Js(e){if(!e||!M.id)return w(e);try{const t=await Rt(e,M.id);if(t.ok){const o=t.result,s={canDeleteMessages:!!o.can_delete_messages,canPromoteMembers:!!o.can_promote_members,canRestrictMembers:!!o.can_restrict_members,canChangeInfo:!!o.can_change_info,canInviteUsers:!!o.can_invite_users};return an(e,s),s}}catch(t){console.warn("Kh√¥ng l·∫•y ƒë∆∞·ª£c quy·ªÅn bot:",t)}return w(e)}async function I(e){try{const t=await ot(e);if(!t.ok)throw new Error(t.description);return Ze(t.result.file_path)}catch(t){return console.error("Failed to get file URL:",t),""}}function zs(e){if(e.target.closest(".msg-action-btn"))return;if(e.target.closest(".msg-sender-name")){const r=e.target.closest(".msg-sender-name"),i=parseInt(r.dataset.userId,10);if(i&&Me()){showMemberModal(i);return}}const t=e.target.closest(".message");if(!t)return;const o=t.dataset.msgId,s=t.innerText.slice(0,30).replace("/ /g"," ");Qs(o,s)}function Me(){if(!m)return!1;const e=b(m);if(!e||e.type!=="group"&&e.type!=="supergroup")return!1;const t=w(m);return t.canRestrictMembers||t.canPromoteMembers}function Qs(e,t){tn(e),n.replyText.textContent=t,n.replyContext.classList.remove("hidden")}function Se(){nn(),n.replyContext.classList.add("hidden")}async function Ge(){const e=n.inputEl.value.trim();if(!e)return;if(!E){alert(a("needToken"));return}if(!m){alert(a("pleaseSelectConversation"));return}const t={chat_id:m,text:e};A&&(t.reply_to_message_id=parseInt(A,10));const o=Ee(n.messagesEl);n.inputEl.value="",Se(),te();try{const s=await k("sendMessage",t);if(s.ok){const r=s.result,i={id:r.message_id,side:"right",type:"text",text:e,date:r.date*1e3,fromName:a("you"),reply_to:t.reply_to_message_id,reply_preview:A?ne(e):null},c=m;if(H(c),oe(c,i)){const l=w(c);W(i,n.messagesEl,K,{canDeleteOthers:l.canDeleteMessages,canManageMembers:Me()}),C.autoScroll&&o?(R(n.messagesEl),n.newMsgBtn.style.display="none"):Ce(n.newMsgBtn,n.messagesEl),D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),$(E,v)}}else alert(a("messageSendFailed",{error:s.description||a("unknownError")}))}catch(s){alert(a("networkError",{error:s.message}))}}async function Zs(e){if(!e||!m){alert(a("selectFile"));return}const t=n.inputEl.value.trim();n.inputEl.value="",Se(),te();const o=new FormData;o.append("chat_id",m),t&&o.append("caption",t);let s="sendDocument",r="document",i="document";e.type.startsWith("image/")?(s="sendPhoto",r="photo",i="photo"):e.type.startsWith("video/")?(s="sendVideo",r="video",i="video"):e.type.startsWith("audio/")&&(s="sendAudio",r="audio",i="audio"),o.append(r,e,e.name||void 0);const c=Ee(n.messagesEl);try{const l=await tt(s,o);if(l.ok){const u=l.result;let f="",d=e.name||"";if(i==="photo"){const B=u.photo[u.photo.length-1];f=await I(B.file_id)}else i==="video"?f=await I(u.video.file_id):i==="audio"?f=await I(u.audio.file_id):(f=await I(u.document.file_id),d=u.document.file_name||d);const p={id:u.message_id,side:"right",type:i,mediaUrl:f,caption:t,fileName:d,date:u.date*1e3,fromName:a("you")},h=m;if(H(h),oe(h,p)){const B=w(h);W(p,n.messagesEl,K,{canDeleteOthers:B.canDeleteMessages,canManageMembers:Me()}),C.autoScroll&&c?(R(n.messagesEl),n.newMsgBtn.style.display="none"):Ce(n.newMsgBtn,n.messagesEl),D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),$(E,v)}}else alert(a("fileSendFailed",{error:l.description||a("unknownError")}))}catch(l){alert(a("networkError",{error:l.message}))}}async function K(e){if(!confirm(a("confirmDelete")))return;const t=m;if(t)try{const o=await Ut(t,e);if(o.ok){cn(t,e);const s=b(t),r=w(t);me(s,n.messagesEl,K,{canDeleteOthers:r.canDeleteMessages,isGroupChat:s.type==="group"||s.type==="supergroup",onUserClick:we}),D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),$(E,v),g(a("success"),a("messageDeleted"),n.toastsEl)}else{const s=o.description||a("cannotDeleteMessage");g(a("error"),s,n.toastsEl)}}catch(o){g(a("error"),a("networkError",{error:o.message}),n.toastsEl)}}async function We(){var t;const e=(t=n.openChatInputEl)==null?void 0:t.value.trim();if(!e){g(a("warning"),a("enterChatIdOrUsername"),n.toastsEl);return}try{let o=e;if(e.startsWith("@")){const r=e.substring(1);g(a("searching"),a("searchingForUser",{username:r}),n.toastsEl),o="@"+r}const s=await At(o);if(s.ok){const r=s.result,i=String(r.id),l=r.type==="private"?[r.first_name,r.last_name].filter(Boolean).join(" ")||r.username||a("user"):r.title||r.type||"Chat";b(i)||(H(i,{type:r.type,title:l,avatarText:F(l)}),g(a("found"),l,n.toastsEl)),D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),S(i),n.openChatInputEl&&(n.openChatInputEl.value="")}else g(a("notFound"),s.description||a("chatNotFound"),n.toastsEl)}catch(o){g(a("error"),a("searchError",{error:o.message}),n.toastsEl)}}function er(){if(!m)return;const e=b(m);!e||e.type!=="group"&&e.type!=="supergroup"||(n.membersOverlayEl.classList.remove("hidden"),he(yt),St(!1))}function Xe(){n.membersOverlayEl.classList.add("hidden")}function he(e){var t,o,s,r,i,c,l,u;yt=e,e==="members"?((t=n.membersTabBtn)==null||t.classList.add("active"),(o=n.groupTabBtn)==null||o.classList.remove("active"),(s=n.membersTabPanel)==null||s.classList.add("active"),(r=n.groupSettingsTab)==null||r.classList.remove("active")):((i=n.membersTabBtn)==null||i.classList.remove("active"),(c=n.groupTabBtn)==null||c.classList.add("active"),(l=n.membersTabPanel)==null||l.classList.remove("active"),(u=n.groupSettingsTab)==null||u.classList.add("active"),tr())}function tr(){const e=b(m);e&&(n.groupNameInputEl&&(n.groupNameInputEl.value=e.title||""),n.groupDescriptionInputEl&&(n.groupDescriptionInputEl.value=e.description||""))}async function nr(){var s,r,i;if(!m)return;const e=(s=n.groupNameInputEl)==null?void 0:s.value.trim(),t=(r=n.groupDescriptionInputEl)==null?void 0:r.value.trim(),o=(i=n.groupPhotoInputEl)==null?void 0:i.files[0];try{if(e&&(await xs(m,e)).ok){const l=b(m);l&&(l.title=e,se()),g("‚úÖ Th√†nh c√¥ng","ƒê√£ c·∫≠p nh·∫≠t t√™n nh√≥m",n.toastsEl)}if(t&&(await Ds(m,t)).ok){const l=b(m);l&&(l.description=t),g("‚úÖ Th√†nh c√¥ng","ƒê√£ c·∫≠p nh·∫≠t m√¥ t·∫£",n.toastsEl)}o&&(await Ns(m,o)).ok&&g("‚úÖ Th√†nh c√¥ng","ƒê√£ c·∫≠p nh·∫≠t ·∫£nh ƒë·∫°i di·ªán",n.toastsEl)}catch(c){g("‚ùå L·ªói",c.message,n.toastsEl)}}async function St(e=!0){if(m)try{const t=await Ts(m),o=b(m);t.forEach(r=>{le(m,{id:r.user.id,first_name:r.user.first_name,last_name:r.user.last_name,username:r.user.username,isBot:r.user.is_bot,status:r.status,isAdmin:r.status==="administrator",isCreator:r.status==="creator",raw:r})}),or();const s=ct(m).length;n.groupInfoEl&&(n.groupInfoEl.textContent=`T·ªïng: ${s} th√†nh vi√™n`),e&&g("‚úÖ Th√†nh c√¥ng","ƒê√£ t·∫£i l·∫°i danh s√°ch",n.toastsEl)}catch(t){n.membersHintEl&&(n.membersHintEl.textContent="L·ªói: "+t.message),e&&g("‚ùå L·ªói",t.message,n.toastsEl)}}function or(){if(!n.membersListEl)return;n.membersListEl.innerHTML="",ct(m).forEach(t=>{const o=document.createElement("div");o.className="member-item",o.dataset.userId=t.id;const s=document.createElement("div");s.className="member-avatar",s.textContent=t.avatarText||"?";const r=document.createElement("div");r.className="member-info";const i=document.createElement("div");i.className="member-name",i.textContent=t.displayName||"Ng∆∞·ªùi d√πng";const c=document.createElement("div");c.className="member-status",c.textContent=Us(t.status),r.appendChild(i),r.appendChild(c),o.appendChild(s),o.appendChild(r),n.membersListEl.appendChild(o)})}function qe(){!m||!E||Dt(m,"typing").catch(()=>{})}function sr(){qe(),ue=setInterval(qe,4e3)}function te(){clearInterval(ue),ue=null}async function N(e){e&&(en(e),$(E,v),m===e&&(ke(null),In(n.messagesEl),Z(null,n.headerTitleEl,n.activeAvatarEl),n.inputEl.disabled=!0),D(v,m,n.emptyNoticeEl,n.chatListEl,S,N),g("Th√†nh c√¥ng","ƒê√£ x√≥a chat",n.toastsEl))}function we(e,t,o=null){if(!e||!m)return;const s=b(m);!s||s.type!=="group"&&s.type!=="supergroup"||(window.currentUserAction={userId:e,userName:t,userUsername:o,chatId:m},rr(t,o,e))}function rr(e,t=null,o=null){const s=[];s.push(`<strong>${e}</strong>`),t&&s.push(`@${t}`),o&&s.push(`ID: ${o}`),n.userActionsTitle.innerHTML=s.join(" ‚Ä¢ "),n.userActionsMenu.classList.remove("hidden")}function z(){n.userActionsMenu.classList.add("hidden"),window.currentUserAction=null}async function T(e){if(!window.currentUserAction)return;const{userId:t,userName:o,userUsername:s,chatId:r}=window.currentUserAction;try{switch(e){case"copyId":t&&navigator.clipboard.writeText(t.toString()).then(()=>{g("Th√†nh c√¥ng",`ƒê√£ copy ID: ${t}`,n.toastsEl)}).catch(()=>{g("L·ªói","Kh√¥ng th·ªÉ copy ID",n.toastsEl)});break;case"copyUsername":if(s){const i=s.startsWith("@")?s:`@${s}`;navigator.clipboard.writeText(i).then(()=>{g("Th√†nh c√¥ng",`ƒê√£ copy username: ${i}`,n.toastsEl)}).catch(()=>{g("L·ªói","Kh√¥ng th·ªÉ copy username",n.toastsEl)})}else g("Th√¥ng b√°o","Ng∆∞·ªùi d√πng kh√¥ng c√≥ username",n.toastsEl);break;case"kick":confirm(`Kick ${o} kh·ªèi nh√≥m?`)&&(await Ls(r,t),g("Th√†nh c√¥ng",`ƒê√£ kick ${o}`,n.toastsEl));break;case"promote":await ce(r,t,"admin"),g("Th√†nh c√¥ng",`ƒê√£ thƒÉng ${o} l√†m admin`,n.toastsEl);break;case"moderate":await ce(r,t,"moderator"),g("Th√†nh c√¥ng",`ƒê√£ thƒÉng ${o} l√†m moderator`,n.toastsEl);break;case"demote":await ce(r,t,"member"),g("Th√†nh c√¥ng",`ƒê√£ h·∫° ${o} th√†nh th√†nh vi√™n`,n.toastsEl);break;case"restrict":g("Th√¥ng b√°o","T√≠nh nƒÉng h·∫°n ch·∫ø quy·ªÅn ƒëang ph√°t tri·ªÉn",n.toastsEl);break}}catch(i){g("L·ªói",`Kh√¥ng th·ª±c hi·ªán t√°c v·ª•: ${i.message}`,n.toastsEl)}z()}function ir(){if(!n.stickerPanel)return;n.stickerPanel.classList.toggle("hidden")||ar()}function ar(){n.stickerPanel.classList.remove("hidden");const e=ut(E);Promise.all(e.map(async o=>{if(!o.url&&o.file_id)try{const s=await ot(o.file_id);s.ok&&(o.url=Ze(s.result.file_path))}catch(s){console.warn("Failed to get sticker URL:",s)}return o})).then(o=>{_n(o,n.stickerList,cr)})}function wt(){n.stickerPanel.classList.add("hidden")}async function cr(e){if(!m){g("L·ªói","Ch·ªçn chat tr∆∞·ªõc",n.toastsEl);return}try{await Nt(m,e.file_id),wt();const t={id:Date.now(),side:"right",date:Date.now(),fromName:M.name||"Bot",type:"sticker",mediaUrl:e.url,stickerFormat:e.is_animated?"tgs":e.is_video?"webm":"webp",emoji:e.emoji||""};oe(m,t),W(t,n.messagesEl,K,{canDeleteOthers:!1,isGroupChat:!1}),R(n.messagesEl)}catch(t){g("L·ªói",`Kh√¥ng g·ª≠i sticker: ${t.message}`,n.toastsEl)}}window.scrollToMessage=function(e,t){m!==e&&S(e),setTimeout(()=>{const o=document.querySelector(`[data-msg-id="${t}"]`);o&&(o.scrollIntoView({behavior:"smooth",block:"center"}),o.style.animation="pulse 1s ease-in-out",setTimeout(()=>{o.style.animation=""},1e3))},500)};function Ve(){if(!n||!n.sidebarCloseBtn)return;window.innerWidth<=840?n.sidebarCloseBtn.style.display="grid":n.sidebarCloseBtn.style.display="none"}document.addEventListener("DOMContentLoaded",Ps);window.addEventListener("beforeunload",()=>{E&&$(E,v)});
